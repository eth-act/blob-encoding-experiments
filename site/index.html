<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blob Encoding Results</title>
    <style>
        /* === VARIABLES === */
        :root {
            --color-bg: #f5f5f5;
            --color-text: #333;
            --color-text-muted: #666;
            --color-text-light: #999;
            --color-border: #eee;
            --color-good: #22c55e;
            --color-bad: #ef4444;
            --color-best-bg: #dcfce7;
            --color-code-bg: #f0f0f0;
            --color-encoding: #1565c0;
            --color-encoding-bg: #e3f2fd;
            --color-compression: #e65100;
            --color-compression-bg: #fff3e0;
            --color-packing: #7b1fa2;
            --color-packing-bg: #f3e5f5;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --radius: 8px;
        }

        /* === BASE === */
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: var(--color-bg);
        }
        h1 { color: var(--color-text); }
        h2 { color: var(--color-text); margin-top: 30px; }

        /* === PANELS (shared card/legend/controls style) === */
        .panel {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 15px;
        }

        /* === SUMMARY CARDS === */
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .card { padding: 20px; }
        .card h3 { margin: 0 0 10px 0; color: var(--color-text-muted); font-size: 14px; }
        .card .value { font-size: 32px; font-weight: bold; color: var(--color-text); }
        .card .sub { color: var(--color-text-light); font-size: 14px; }

        /* === LEGEND === */
        .legend { padding: 20px; margin-bottom: 20px; }
        .legend h3 { margin: 0 0 15px 0; color: var(--color-text); }
        .legend > p { margin: 0 0 15px 0; color: var(--color-text-muted); }
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .legend-section h4 {
            margin: 0 0 8px 0;
            color: var(--color-text-muted);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .legend-section ul {
            margin: 0;
            padding-left: 0;
            list-style: none;
        }
        .legend-section li {
            margin: 4px 0;
            font-size: 14px;
            color: #555;
        }
        .legend-section li code {
            min-width: 100px;
            display: inline-block;
        }
        .legend-example {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--color-border);
        }
        .legend-example code {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .column-legend {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--color-border);
        }
        .column-legend h4 {
            margin: 0 0 10px 0;
            color: var(--color-text-muted);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .column-legend dl {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 4px 12px;
            margin: 0;
            font-size: 14px;
        }
        .column-legend dt { font-weight: 600; color: var(--color-text); }
        .column-legend dd { margin: 0; color: #555; }

        /* === CONTROLS === */
        .controls { padding: 15px; }
        .controls label { font-size: 14px; color: #555; }
        .controls label + label { margin-left: 15px; }
        .controls select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 200px;
        }
        .controls button {
            margin-left: 15px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
        }
        .controls button:hover { background: var(--color-bg); }
        .filter-count { margin-left: 15px; color: var(--color-text-muted); }

        /* === TABLES === */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--color-border); }
        th { background: var(--color-text); color: white; font-weight: 500; cursor: help; }
        tr:hover { background: #f9f9f9; }

        /* === TABLE UTILITIES === */
        .good { color: var(--color-good); }
        .bad { color: var(--color-bad); }
        .neutral { color: var(--color-text-muted); }
        .best { background: var(--color-best-bg); }
        .error { color: var(--color-bad); padding: 20px; background: white; border-radius: var(--radius); }

        /* === CODE BADGES === */
        code {
            background: var(--color-code-bg);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
        }
        td code { font-size: 12px; white-space: nowrap; }
        #results td:nth-child(1) code { background: var(--color-encoding-bg); color: var(--color-encoding); }
        #results td:nth-child(2) code { background: var(--color-compression-bg); color: var(--color-compression); }
        #results td:nth-child(3) code { background: var(--color-packing-bg); color: var(--color-packing); }

        /* === SPACING === */
        .mt-lg { margin-top: 40px; }
    </style>
</head>
<body>
    <h1>Blob Encoding Benchmark Results</h1>

    <!-- Summary Cards -->
    <div class="summary" id="summary"></div>

    <!-- Legend -->
    <div class="panel legend">
        <h3>Strategy Legend</h3>
        <p>Strategies are named as <code>encoding + compression + packing</code></p>
        <div class="legend-grid">
            <div class="legend-section">
                <h4>Encoding (tx list format)</h4>
                <ul>
                    <li><code>rlp</code> — RLP-encoded transaction list</li>
                    <li><code>ssz</code> — SSZ-encoded transaction list</li>
                    <li><code>rlp_pertx_*</code> — Each tx compressed individually, then RLP list</li>
                </ul>
            </div>
            <div class="legend-section">
                <h4>Compression</h4>
                <ul>
                    <li><code>none</code> — No compression (baseline)</li>
                    <li><code>snappy</code> — Fast, balanced compression</li>
                    <li><code>zstd_1</code> — Zstandard level 1 (fastest)</li>
                    <li><code>zstd_3</code> — Zstandard level 3</li>
                    <li><code>zstd_6</code> — Zstandard level 6</li>
                    <li><code>zstd_22</code> — Zstandard level 22 (max compression)</li>
                    <li><code>gzip_9</code> — Gzip level 9</li>
                </ul>
            </div>
            <div class="legend-section">
                <h4>Packing (blob field encoding)</h4>
                <ul>
                    <li><code>naive_31</code> — 31 bytes per 32-byte field element (simple)</li>
                    <li><code>bitpack_254</code> — 254 bits per field element (optimized)</li>
                </ul>
            </div>
        </div>
        <div class="legend-example">
            <strong>Example:</strong> <code>rlp_pertx_zstd_3+zstd_22+bitpack_254</code> means:
            compress each tx with zstd level 3, wrap in RLP list, then compress entire list with zstd level 22, then bitpack into blobs.
        </div>
        <div class="column-legend">
            <h4>Column Definitions</h4>
            <dl>
                <dt>Blobs</dt>
                <dd>Number of 128KB blobs needed to store all data</dd>
                <dt>vs Baseline</dt>
                <dd>Difference from rlp+none+naive_31 (no compression)</dd>
                <dt>Compressed</dt>
                <dd>Size after blob-level compression is applied</dd>
                <dt>Ratio</dt>
                <dd>Overall compression: Tx Raw ÷ Compressed</dd>
                <dt>Efficiency</dt>
                <dd>How full the blobs are: Tx Raw ÷ (Blobs × usable capacity)</dd>
            </dl>
        </div>
    </div>

    <!-- Aggregate Results -->
    <h2>Aggregate Results</h2>
    <div class="panel controls">
        <label>Encoding:
            <select id="encFilter"><option value="">All</option></select>
        </label>
        <label>Compression:
            <select id="compFilter"><option value="">All</option></select>
        </label>
        <label>Packing:
            <select id="packFilter"><option value="">All</option></select>
        </label>
        <button id="resetFilters">Reset</button>
        <span id="filterCount" class="filter-count"></span>
    </div>
    <table id="results">
        <thead>
            <tr>
                <th title="Transaction list encoding format">Encoding</th>
                <th title="Compression algorithm applied to blob data">Compression</th>
                <th title="How data is packed into blob field elements">Packing</th>
                <th title="Number of 128KB blobs needed">Blobs</th>
                <th title="Difference from rlp+none+naive_31 baseline">vs Baseline</th>
                <th title="Size after blob-level compression">Compressed</th>
                <th title="Overall compression ratio: Tx Raw ÷ Compressed">Ratio</th>
                <th title="Average time to compress and pack into blobs">Enc (ms)</th>
                <th title="Average time to unpack and decompress">Dec (ms)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Individual Block Results -->
    <h2 class="mt-lg">Individual Block Results</h2>
    <div class="panel controls">
        <label>Strategy:
            <select id="strategyFilter"><option value="">All strategies</option></select>
        </label>
        <label>Block:
            <select id="blockFilter"><option value="">All blocks</option></select>
        </label>
    </div>
    <table id="individual">
        <thead>
            <tr>
                <th>Block</th>
                <th>Strategy</th>
                <th title="Number of 128KB blobs needed">Blobs</th>
                <th title="Sum of raw transaction bytes (before encoding)">Tx Raw</th>
                <th title="Size after tx list encoding (includes per-tx compression)">Encoded</th>
                <th title="Size after blob-level compression">Compressed</th>
                <th title="How full the blobs are: Tx Raw ÷ (Blobs × usable capacity)">Efficiency</th>
                <th title="Time to compress and pack into blobs">Encode (ms)</th>
                <th title="Time to unpack and decompress">Decode (ms)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
    /* === CONSTANTS === */
    const BASELINE = { encoding: 'rlp', compression: 'none', packing: 'naive_31' };

    /* === STATE === */
    let allData = [];
    let aggregatedData = [];
    let baselineBlobs = 0;

    /* === UTILITIES === */
    function formatBytes(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / 1024 / 1024).toFixed(2) + ' MB';
    }

    function getStrategyKey(r) {
        return `${r.encoding}+${r.compression}+${r.packing}`;
    }

    function populateSelect(selectId, values, defaultLabel = 'All') {
        const select = document.getElementById(selectId);
        select.innerHTML = `<option value="">${defaultLabel}</option>`;
        values.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v;
            select.appendChild(opt);
        });
    }

    /* === DATA PROCESSING === */
    function aggregateResults(data) {
        const byStrategy = {};

        for (const r of data) {
            const key = getStrategyKey(r);
            if (!byStrategy[key]) {
                byStrategy[key] = {
                    encoding: r.encoding,
                    compression: r.compression,
                    packing: r.packing,
                    blobs: 0,
                    txRawSize: 0,
                    encodedSize: 0,
                    compressedSize: 0,
                    encodeTime: 0,
                    decodeTime: 0,
                    count: 0
                };
            }
            const s = byStrategy[key];
            s.blobs += r.blob_count;
            s.txRawSize += r.tx_raw_size ?? r.raw_size;
            s.encodedSize += r.encoded_size ?? r.raw_size;
            s.compressedSize += r.compressed_size;
            s.encodeTime += r.encode_time_ms;
            s.decodeTime += r.decode_time_ms;
            s.count++;
        }

        return Object.values(byStrategy).map(s => ({
            ...s,
            encodeTime: s.encodeTime / s.count,
            decodeTime: s.decodeTime / s.count
        }));
    }

    /* === RENDER: SUMMARY CARDS === */
    function renderSummary(baselineData, bestStrategy, savings) {
        const totalBlocks = allData.length / aggregatedData.length;
        document.getElementById('summary').innerHTML = `
            <div class="panel card">
                <h3>BLOCKS ANALYZED</h3>
                <div class="value">${totalBlocks}</div>
                <div class="sub">${formatBytes(baselineData?.txRawSize || 0)} total tx data</div>
            </div>
            <div class="panel card">
                <h3>BEST STRATEGY</h3>
                <div class="value">${bestStrategy.compression}</div>
                <div class="sub">${bestStrategy.encoding}+${bestStrategy.packing}</div>
            </div>
            <div class="panel card">
                <h3>BLOB SAVINGS</h3>
                <div class="value good">-${savings}</div>
                <div class="sub">${((savings / baselineBlobs) * 100).toFixed(1)}% reduction vs baseline</div>
            </div>
            <div class="panel card">
                <h3>BASELINE BLOBS</h3>
                <div class="value">${baselineBlobs}</div>
                <div class="sub">rlp+none+naive_31</div>
            </div>
        `;
    }

    /* === RENDER: AGGREGATE TABLE === */
    function renderAggregateTable() {
        const encFilter = document.getElementById('encFilter').value;
        const compFilter = document.getElementById('compFilter').value;
        const packFilter = document.getElementById('packFilter').value;

        let filtered = aggregatedData;
        if (encFilter) filtered = filtered.filter(s => s.encoding === encFilter);
        if (compFilter) filtered = filtered.filter(s => s.compression === compFilter);
        if (packFilter) filtered = filtered.filter(s => s.packing === packFilter);

        const sorted = [...filtered].sort((a, b) => a.blobs - b.blobs);
        const bestBlobs = sorted.length > 0 ? sorted[0].blobs : 0;

        document.getElementById('filterCount').textContent =
            `Showing ${filtered.length} of ${aggregatedData.length} strategies`;

        document.querySelector('#results tbody').innerHTML = sorted.map(s => {
            const diff = s.blobs - baselineBlobs;
            const pct = ((diff / baselineBlobs) * 100).toFixed(1);
            const ratio = (s.txRawSize / s.compressedSize).toFixed(2);
            const diffClass = diff < 0 ? 'good' : (diff > 0 ? 'bad' : 'neutral');

            return `
                <tr class="${s.blobs === bestBlobs ? 'best' : ''}">
                    <td><code>${s.encoding}</code></td>
                    <td><code>${s.compression}</code></td>
                    <td><code>${s.packing}</code></td>
                    <td><strong>${s.blobs}</strong></td>
                    <td class="${diffClass}">${diff >= 0 ? '+' : ''}${diff} (${pct}%)</td>
                    <td>${formatBytes(s.compressedSize)}</td>
                    <td>${ratio}x</td>
                    <td>${s.encodeTime.toFixed(2)}</td>
                    <td>${s.decodeTime.toFixed(2)}</td>
                </tr>
            `;
        }).join('');
    }

    /* === RENDER: INDIVIDUAL TABLE === */
    function renderIndividualTable() {
        const strategyFilter = document.getElementById('strategyFilter').value;
        const blockFilter = document.getElementById('blockFilter').value;

        let filtered = allData;
        if (strategyFilter) filtered = filtered.filter(r => getStrategyKey(r) === strategyFilter);
        if (blockFilter) filtered = filtered.filter(r => r.payload_file === blockFilter);

        document.querySelector('#individual tbody').innerHTML = filtered.map(r => {
            const txRaw = r.tx_raw_size ?? r.raw_size;
            const encoded = r.encoded_size ?? r.raw_size;
            return `
                <tr>
                    <td>${r.payload_file}</td>
                    <td><strong>${getStrategyKey(r)}</strong></td>
                    <td>${r.blob_count}</td>
                    <td>${formatBytes(txRaw)}</td>
                    <td>${formatBytes(encoded)}</td>
                    <td>${formatBytes(r.compressed_size)}</td>
                    <td>${(r.space_efficiency * 100).toFixed(1)}%</td>
                    <td>${r.encode_time_ms.toFixed(2)}</td>
                    <td>${r.decode_time_ms.toFixed(2)}</td>
                </tr>
            `;
        }).join('');
    }

    /* === MAIN RENDER === */
    function renderAll(data) {
        allData = data;
        aggregatedData = aggregateResults(data);

        const sorted = [...aggregatedData].sort((a, b) => a.blobs - b.blobs);
        const baselineData = aggregatedData.find(s =>
            s.encoding === BASELINE.encoding &&
            s.compression === BASELINE.compression &&
            s.packing === BASELINE.packing
        );
        baselineBlobs = baselineData?.blobs || sorted[sorted.length - 1].blobs;

        const bestStrategy = sorted[0];
        const savings = baselineBlobs - bestStrategy.blobs;

        // Populate all filters
        populateSelect('encFilter', [...new Set(aggregatedData.map(r => r.encoding))].sort(), 'All');
        populateSelect('compFilter', [...new Set(aggregatedData.map(r => r.compression))].sort(), 'All');
        populateSelect('packFilter', [...new Set(aggregatedData.map(r => r.packing))].sort(), 'All');
        populateSelect('strategyFilter', [...new Set(data.map(getStrategyKey))].sort(), 'All strategies');
        populateSelect('blockFilter', [...new Set(data.map(r => r.payload_file))].sort(), 'All blocks');

        // Render everything
        renderSummary(baselineData, bestStrategy, savings);
        renderAggregateTable();
        renderIndividualTable();
    }

    /* === EVENT LISTENERS === */
    document.getElementById('encFilter').addEventListener('change', renderAggregateTable);
    document.getElementById('compFilter').addEventListener('change', renderAggregateTable);
    document.getElementById('packFilter').addEventListener('change', renderAggregateTable);
    document.getElementById('resetFilters').addEventListener('click', () => {
        document.getElementById('encFilter').value = '';
        document.getElementById('compFilter').value = '';
        document.getElementById('packFilter').value = '';
        renderAggregateTable();
    });
    document.getElementById('strategyFilter').addEventListener('change', renderIndividualTable);
    document.getElementById('blockFilter').addEventListener('change', renderIndividualTable);

    /* === INIT === */
    fetch('results.json')
        .then(res => {
            if (!res.ok) throw new Error('Failed to load results.json');
            return res.json();
        })
        .then(renderAll)
        .catch(err => {
            document.getElementById('summary').innerHTML =
                `<div class="error">Error: ${err.message}. Make sure results.json exists in the site folder.</div>`;
        });
    </script>
</body>
</html>
